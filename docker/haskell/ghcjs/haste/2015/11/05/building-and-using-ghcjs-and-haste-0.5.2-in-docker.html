<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Building and using ghc, ghcjs and Haste in Docker | Dave Compton</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Building and using ghc, ghcjs and Haste in Docker" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Dec 5, 2015 : Now building with Haste 0.5.3 ( previously was 0.5.2 ) Dec 12, 2015 : Now building with ghc 7.10.3 ( previously was 7.10.2 ) Dec 26, 2015 : No longer using sshd for shell access. March 14, 2016 : Allowing for optional sshd at runtime." />
<meta property="og:description" content="Dec 5, 2015 : Now building with Haste 0.5.3 ( previously was 0.5.2 ) Dec 12, 2015 : Now building with ghc 7.10.3 ( previously was 7.10.2 ) Dec 26, 2015 : No longer using sshd for shell access. March 14, 2016 : Allowing for optional sshd at runtime." />
<meta property="og:site_name" content="Dave Compton" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2015-11-05T05:37:20-08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Building and using ghc, ghcjs and Haste in Docker" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2015-11-05T05:37:20-08:00","datePublished":"2015-11-05T05:37:20-08:00","description":"Dec 5, 2015 : Now building with Haste 0.5.3 ( previously was 0.5.2 ) Dec 12, 2015 : Now building with ghc 7.10.3 ( previously was 7.10.2 ) Dec 26, 2015 : No longer using sshd for shell access. March 14, 2016 : Allowing for optional sshd at runtime.","headline":"Building and using ghc, ghcjs and Haste in Docker","mainEntityOfPage":{"@type":"WebPage","@id":"/docker/haskell/ghcjs/haste/2015/11/05/building-and-using-ghcjs-and-haste-0.5.2-in-docker.html"},"url":"/docker/haskell/ghcjs/haste/2015/11/05/building-and-using-ghcjs-and-haste-0.5.2-in-docker.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css">
  <link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="Dave Compton" />
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Dave Compton</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Building and using ghc, ghcjs and Haste in Docker</h1>
    <p class="post-meta"><time class="dt-published" datetime="2015-11-05T05:37:20-08:00" itemprop="datePublished">
        Nov 5, 2015
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul>
  <li><strong>Dec 5, 2015 :  Now building with Haste 0.5.3 ( previously was 0.5.2 )</strong></li>
  <li><strong>Dec 12, 2015 :  Now building with ghc 7.10.3 ( previously was 7.10.2 )</strong></li>
  <li><strong>Dec 26, 2015 :  No longer using sshd for shell access.</strong></li>
  <li><strong>March 14, 2016 :  Allowing for optional sshd at runtime.</strong></li>
</ul>

<hr />

<p><a href="/haskell/ghcjs/docker/2015/08/05/installing-and-using-ghcjs-in-a-docker-image.html">This earlier post described how to create and use a docker environment for ghcjs development.</a></p>

<p><a href="/2015/08/27/building-and-using-haste-0.5.0-in-docker.html">This earlier post extends the original ghcjs post to include Haste.</a></p>

<p>This post supersedes both of those earlier posts.</p>

<h1 id="summary">Summary:</h1>
<p>This post explains how to quickly build a Haskell development development environment (including ghcjs and Haste) that runs under Docker.  To build and use this development environment you should be running a 64 bit Linux version (Windows or OSX might also work using boot2docker but I have not tried either of those).</p>

<h1 id="introduction">Introduction:</h1>
<p>Earlier this year I started working with ghcjs, a Haskell to Javascript compiler.  At the time I was using ghc 7.6.3, which is too old to be supported by ghcjs.  Not wanting to risk messing up my working Haskell environment, I decided to try using Docker to create a isolated ghcjs workspace.  When a new version of Haste was released, I added it to the configuration.</p>

<p>The eventual result was a Dockerfile (a type of script that can be used to create a Docker image ) that creates a Docker based Haskell working environment.</p>

<p>This has become my default Haskell workspace - not just for ghcjs but for all my Haskell work.</p>

<p>The resulting image is based on Ubuntu 15.10 (aka “Wily Werewolf”) and contains :</p>

<ul>
  <li>Compilers
    <ul>
      <li><strong>ghc 7.10.3</strong> (built from source using ghc 7.8.4)</li>
      <li><strong>haste 0.5.3</strong> (built from source using ghc 7.10.3)</li>
      <li><strong>ghcjs</strong> ( the most recent as of time of image creation ; built from source using ghc 7.10.3 )</li>
    </ul>
  </li>
  <li>Haskell development tools
    <ul>
      <li><strong>cabal 1.22.6</strong>  (built from source)</li>
      <li><strong>ghc-mod</strong> &amp; <strong>ghc-modi</strong> (via cabal)</li>
      <li><strong>hdevtools</strong> (via cabal)</li>
      <li><strong>ghcid</strong> (via cabal)</li>
      <li><strong>hlint</strong> (via cabal)</li>
      <li><strong>stack</strong> (from fpcomplete via apt-get)</li>
    </ul>
  </li>
  <li>Editors
    <ul>
      <li><strong>vim</strong> (via apt-get; with Haskell related extensions)
        <ul>
          <li><strong>pathogen</strong> (cloned from github)</li>
          <li><strong>syntastic</strong> (cloned from github)</li>
          <li><strong>vim-hdevtools</strong> (cloned from github)</li>
          <li><strong>vim2hs</strong> (cloned from github)</li>
          <li><strong>vimproc</strong> (cloned from github)</li>
          <li><strong>ghcmod-vim</strong> (cloned from github)</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Miscelaneous
    <ul>
      <li><strong>tmux</strong> (via apt-get)</li>
    </ul>
  </li>
</ul>

<h1 id="building">Building:</h1>
<p>To build this image, you will need to first <a href="https://docs.docker.com/installation/">install docker</a> version 1.7 or later.</p>

<p>After installing Docker, clone the git repository holding the Dockerfile and related build scripts.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/dc25/dockerfile_for_haskell.git
</code></pre></div></div>

<p>From inside the repository, run Docker to build your image:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo docker build -t &lt;imageName&gt; .
</code></pre></div></div>

<p>On my computer this takes about three hours.</p>

<h1 id="running">Running:</h1>

<p>Run the new image as follows:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo docker  run -it --entrypoint /start.sh &lt;imageName&gt; `id -u -n` `id -u`
</code></pre></div></div>

<p>This will start a container and create a user inside that container with same name and id as you have on your host machine.  This allows you to work on files and directories mounted from the host machine without permission problems.</p>

<p>If you want to mount a directory from the host machine, use the -v docker option:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo docker  run -it -v /hostpath:/containerpath --entrypoint /start.sh &lt;imageName&gt; `id -u -n` `id -u`
</code></pre></div></div>

<p>If you want to run a sshd daemon in the docker environment, add your ssh public key (the contents of ~/.ssh/id_dsa.pub or ~/.ssh/id_rsa.pub) as an additional argument to the command line:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo docker  run -it -v /hostpath:/containerpath --entrypoint /start.sh &lt;imageName&gt; `id -u -n` `id -u` "`cat ~/.ssh/id_dsa.pub`"
</code></pre></div></div>

<p>If you start the docker environment in this way, you can access it using a passwordless ssh login from the host machine.  The advantage of doing this is that tmux seems to behave better in an ssh shell than in a bash shell.  I don’t know why.</p>

<p>I use the following two bash functions to start my docker/haskell environment.  Each takes one argument: the name of the docker image to be run.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>function doba
{
    sudo docker run -it -v /hostpath:/containerpath --entrypoint /start.sh $1 `id -u -n` `id -u`
}

function dosh
{
    sudo docker run -it -v /hostpath:/containerpath --entrypoint /start.sh $1 `id -u -n` `id -u` "`cat ~/.ssh/id_dsa.pub`"
}
</code></pre></div></div>

<p>You will need the ip addresses of the running docker container to ssh into it.  The following bash function will display that address.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>function doip
{
    sudo docker ps -q | xargs sudo docker inspect --format '{{ .NetworkSettings.IPAddress }}'
}
</code></pre></div></div>

<p>The directory <strong>build_scripts</strong> contains the following files intended for customization</p>

<ul>
  <li><strong>personalize.sh</strong>: Invoked once when the container starts.</li>
  <li><strong>myBashrc</strong>: Invoked from inside every bash shell that runs inside the container.</li>
  <li><strong>myVimrc</strong>: This will be sourced by vim when it starts.</li>
</ul>

<h1 id="using-tmux">Using tmux</h1>

<p>Inside the docker container, you will be running tmux, a terminal based window manager.  At first you can just disregard tmux but at some point you will want to work with multiple shells.  This is where tmux comes in handy.</p>

<p>To manage multiple bash shells, I generally make the terminal that I’m using full screen and then use tmux commands to split the window into multiple panes and navigate from one pane to another.  The following tmux commands should be enough to get started:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Keystrokes —&gt;</th>
      <th style="text-align: left">Effect</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">^b %</td>
      <td style="text-align: left">split screen vertically</td>
    </tr>
    <tr>
      <td style="text-align: left">^b “</td>
      <td style="text-align: left">split screen horizontally</td>
    </tr>
    <tr>
      <td style="text-align: left">^b o</td>
      <td style="text-align: left">move to next pane</td>
    </tr>
  </tbody>
</table>

<p>I’ve found <a href="http://www.mechanicalkeys.com/files/os/notes/tm.html">this tmux cheatsheet</a> to be useful.</p>

<h1 id="versions">Versions</h1>

<p>From within a container you should be able to verify the following versions:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dave@99c4c23f4476:~$ cabal --version
cabal-install version 1.22.6.0
using version 1.22.4.0 of the Cabal library 
dave@99c4c23f4476:~$ ghc --version
The Glorious Glasgow Haskell Compilation System, version 7.10.3
dave@99c4c23f4476:~$ ghcjs --version
The Glorious Glasgow Haskell Compilation System for JavaScript, version 0.2.0 (GHC 7.10.3)
dave@99c4c23f4476:~$ hastec --version
0.5.3
</code></pre></div></div>

<h1 id="feedback">Feedback</h1>

<p>If you made it this far, thank you for reading my post.  If you have any feedback please don’t hesitate to let me know.</p>

<p>- Dave</p>

  </div><a class="u-url" href="/docker/haskell/ghcjs/haste/2015/11/05/building-and-using-ghcjs-and-haste-0.5.2-in-docker.html" hidden></a>
</article>

      </div>
    </main>

    <div class="page-content">
      <div class="wrapper">
        

      </div>
    </div><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <path d="M12.8 16C12.8 8.978 7.022 3.2 0 3.2V0c8.777 0 16 7.223 16 16h-3.2zM2.194
                11.61c1.21 0 2.195.985 2.195 2.196 0 1.21-.99 2.194-2.2 2.194C.98 16 0 15.017 0
                13.806c0-1.21.983-2.195 2.194-2.195zM10.606
                16h-3.11c0-4.113-3.383-7.497-7.496-7.497v-3.11c5.818 0 10.606 4.79 10.606 10.607z"
              />
            </svg><span>Subscribe</span>
          </a>
        </p>
        <ul class="contact-list">
          <li><a class="u-email" href="mailto:davecompton7@gmail.com">davecompton7@gmail.com</a></li>
        </ul>
      </div>
      <div class="footer-col">
        <p>What I am doing, what I have done, and what I learned along the way.
</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"></ul>
</div>

  </div>

</footer>
<!-- Default Statcounter code for Davecompton.net
https://davecompton.net -->
<script type="text/javascript">
var sc_project=11610177; 
var sc_invisible=1; 
var sc_security="d324e394"; 
</script>
<script type="text/javascript"
src="https://www.statcounter.com/counter/counter.js"
async></script>
<noscript><div class="statcounter"><a title="real time web
analytics" href="https://statcounter.com/"
target="_blank"><img class="statcounter"
src="https://c.statcounter.com/11610177/0/d324e394/1/"
alt="real time web analytics"
referrerPolicy="no-referrer-when-downgrade"></a></div></noscript>
<!-- End of Statcounter Code -->
</body>

</html>
